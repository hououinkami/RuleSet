name: æ›´æ–°è§„åˆ™

on:
  push:
    branches:
      - main
    path:
      - .*
  release:
    types: [published]
  schedule:
    - cron: 0 17 * * *
  watch:
    types: [started]

env:
  TZ: Asia/Shanghai
  TELEGRAM_NOTIFICATION: false
  TELEGRAM_NOTIFICATION_CONTENT: <b>ãƒ«ãƒ¼ãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼</b>
  VER: all


jobs:
  UpdateRule:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        ref: main
        fetch-depth: 0
        lfs: true
    
    - name: Set git identity
      run : |
        git config --global user.email "hououinkami@gmail.com"
        git config --global user.name "hououinkami"
    
    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "::set-output name=DATE::$(date +'%Y-%m-%d')"
    
    - name: è·å–æœ€æ–°æº
      run : |
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Module/General.sgmodule -O General.tmp
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Module/Block/Advertising.sgmodule -O Advertising.tmp
        wget https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Advertising/Advertising_MITM.sgmodule -O all_Advertising.tmp
        wget https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rewrite/Surge/AllInOne/AllInOne.sgmodule -O all_Rwrite.tmp
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Outbound.conf -O shenji.tmp
        wget https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/script/bilibili/bilibili_plus.sgmodule -O bili.tmp
        wget https://raw.githubusercontent.com/Maasea/sgmodule/master/YoutubeAds.sgmodule -O youtube_ad.tmp
        wget https://raw.githubusercontent.com/hououinkami/RuleSet/main/Surge/YouTubeAds.sgmodule -O youtube_ad2.tmp
        wget https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/Adblock4limbo.sgmodule -O limbo.tmp
    # ç¤ºä¾‹
    # awk '/^(ç»ˆæ­¢è¡Œèµ·å§‹å­—æ®µ)/{f=0} f; /èµ·å§‹è¡Œå…³é”®å­—/{f=1}' all_Rwrite.tmp>tmp.tmp
    # è¿‡æ»¤ç©ºç™½è¡Œ
    # awk NF tmp.tmp>rule2.tmp
    - name: ç”Ÿæˆç¥æœºè§„åˆ™host
      run : |
        awk '/^(\[)/{f=0} f; /\[Host\]/{f=1}' shenji.tmp>tmp.tmp
        awk '
        {
          if($0~/\# >/ || $0~/=/) {
            if($0!~/hostname/) {
              print $0;
            }
          }      
        }
        ' tmp.tmp>host.tmp
        awk NF host.tmp > Surge/host.tpl

    - name: ç”Ÿæˆç¥æœºè§„åˆ™General
      run : |
        awk '
        {
          if($0~/always-real-ip = \%APPEND\%/) {
            gsub("always-real-ip = %APPEND%","");
            print $0;
            {exit}; 
          }      
        }
        ' General.tmp>realip1.tmp
    
    - name: ç”Ÿæˆç¥æœºè§„åˆ™Advertising
      run : |
        awk '
        {
          if($0~/force-http-engine-hosts/) {
            gsub("force-http-engine-hosts = %APPEND% ","");
            print $0;
            {exit};
          }      
        }
        ' Advertising.tmp>force-http-engine-hosts2.tmp

        awk '/^(\[)/{f=0} f; /\[Map Local\]/{f=1}' Advertising.tmp>tmp.tmp
        awk NF tmp.tmp>map_local2.tmp

    - name: ç”Ÿæˆæ•´åˆè§„åˆ™hostname
      run : |
        awk '
        {
          if($0~/hostname = \%APPEND\%/) {
            gsub("hostname = %APPEND%","");
            print $0 ", ";
            {exit}; 
          }      
        }
        ' all_Advertising.tmp>hostname1.tmp
    
    - name: ç”Ÿæˆæ•´åˆè§„åˆ™Rewrite
      run : |
        awk '
        {
          if($0~/force-http-engine-hosts/) {
            gsub("force-http-engine-hosts = %APPEND% ","");
            print $0;
            {exit};
          }      
        }
        ' all_Rwrite.tmp>force-http-engine-hosts2.tmp

        awk '/^(\[)/{f=0} f; /\[Rule\]/{f=1}' all_Rwrite.tmp>tmp.tmp
        awk NF tmp.tmp>rule2.tmp

        awk '/^(\[)/{f=0} f; /\[URL Rewrite\]/{f=1}' all_Rwrite.tmp>tmp.tmp
        awk '
        {
          if($0!~/imgextra/) {
            print $0;
          }      
        }
        ' tmp.tmp>tmp2.tmp
        awk NF tmp2.tmp>url_rewrite2.tmp

        awk '/^(\[)/{f=0} f; /\[Script\]/{f=1}' all_Rwrite.tmp>tmp.tmp
        awk NF tmp.tmp>script2.tmp

        awk '
        {
          if($0~/hostname = \%APPEND\%/) {
            gsub("hostname = %APPEND%","");
            print $0;
            {exit}; 
          }      
        }
        ' all_Rwrite.tmp>hostname2.tmp

        awk '/^(\[)/{f=0} f; /\[Map Local\]/{f=1}' all_Rwrite.tmp>tmp.tmp
        awk NF tmp.tmp>map_local1.tmp

    - name: ç”ŸæˆYouTubeå¹¿å‘Šå±è”½è§„åˆ™
      run : |
        awk '/^(\[)/{f=0} f; /\[URL Rewrite\]/{f=1}' youtube_ad.tmp>tmp.tmp
        awk NF tmp.tmp>youtube_ad_url_rewrite.tmp

        awk '/^(\[)/{f=0} f; /\[Script\]/{f=1}' youtube_ad.tmp>tmp.tmp
        awk NF tmp.tmp>youtube_ad_script.tmp

        awk '
        {
          if($0~/hostname = \%APPEND\%/) {
            gsub("hostname = %APPEND%","");
            print $0 ", ";
            {exit}; 
          }      
        }
        ' youtube_ad.tmp>youtube_ad_hostname.tmp

    - name: ç”ŸæˆAdblock4limboè§„åˆ™Rewrite
      run : |
        awk '/^(\[)/{f=0} f; /\[URL Rewrite\]/{f=1}' limbo.tmp>tmp.tmp
        awk NF tmp.tmp>limbo_url_rewrite.tmp

        awk '/^(\[)/{f=0} f; /\[Header Rewrite\]/{f=1}' limbo.tmp>tmp.tmp
        awk NF tmp.tmp>limbo_header_rewrite.tmp

        awk '/^(\[)/{f=0} f; /\[Script\]/{f=1}' limbo.tmp>tmp.tmp
        awk NF tmp.tmp>limbo_script.tmp

        awk '
        {
          if($0~/hostname = \%APPEND\%/) {
            gsub("hostname = %APPEND%","");
            print $0 ", ";
            {exit}; 
          }      
        }
        ' limbo.tmp>tmp.tmp
        awk '{if(NR%3!=0)ORS=" ";else ORS="\n "}1' tmp.tmp > limbo_hostname.tmp

    - name: ç”ŸæˆBilibiliè§„åˆ™
      run : |
        awk '/^(\[)/{f=0} f; /\[Rule\]/{f=1}' bili.tmp>tmp.tmp
        awk NF tmp.tmp>bili_rule.tmp

        awk '/^(\[)/{f=0} f; /\[URL Rewrite\]/{f=1}' bili.tmp>tmp.tmp
        awk NF tmp.tmp>bili_url_rewrite.tmp

        awk '/^(\[)/{f=0} f; /\[Script\]/{f=1}' bili.tmp>tmp.tmp
        awk NF tmp.tmp>bili_script.tmp

        awk '
        {
          if($0~/hostname = \%APPEND\%/) {
            gsub("hostname = %APPEND%","");
            print $0 ", ";
            {exit}; 
          }      
        }
        ' bili.tmp>bili_hostname.tmp

    - name: Bilibiliè‡ªåŠ¨åˆ‡æ¢
      run : |
        wget https://raw.githubusercontent.com/NobyDa/Script/master/Surge/JS/Bili_Auto_Regions.js -O biliauto.tmp
        awk '
        {
          gsub("ğŸ“º DomesticMedia","ğŸ“º Bilibili");
          sub("DIRECT","ğŸŒ ç›´è¿");
          gsub("ğŸ‡­ğŸ‡° sub-policy","ğŸ‡­ğŸ‡° é¦™æ¸¯");
          gsub("ğŸ‡¹ğŸ‡¼ sub-policy","ğŸ‡¨ğŸ‡³ å°æ¹¾");
          gsub("ğŸ sub-policy","ğŸ‡­ğŸ‡° é¦™æ¸¯");
          print $0;
        }
        ' biliauto.tmp>Surge/js/Bili_Auto_Regions.js
      
    - name: Bilibiliå¯åŠ¨æ—¶åˆ‡æ¢ä¸ºç›´è¿
      run : |
        wget https://raw.githubusercontent.com/ddgksf2013/Cuttlefish/master/Script/bilibili_startup_direct.js -O bilistart.tmp
        awk '
        {
          gsub("DomesticMedia","ğŸ“º Bilibili");
          sub("direct","ğŸŒ ç›´è¿");
          print $0;
        }
        ' bilistart.tmp>Surge/js/Bilibili_Startup_Direct.js

    - name: åˆå¹¶æ–‡ä»¶_all
      if: env.VER == 'all' && !cancelled()
      run : |
        cat realip*.tmp > Surge/always-real-ip.tpl
        cat force-http-engine-hosts*.tmp > Surge/force-http-engine-hosts.tpl
        cat rule*.tmp > Surge/rule.tpl
        cat limbo_url_rewrite.tmp youtube_ad_url_rewrite.tmp url_rewrite*.tmp > Surge/url_rewrite.tpl
        cat limbo_header_rewrite.tmp > Surge/header_rewrite.tpl
        cat youtube_ad_script.tmp limbo_script.tmp script*.tmp > Surge/script.tpl
        cat map_local*.tmp > Surge/map_local.tpl
        cat limbo_hostname.tmp youtube_ad_hostname.tmp hostname*.tmp > hostname.tmp
        awk '{if(NR%3!=0)ORS=" ";else ORS="\n "}1' hostname.tmp > Surge/hostname.tpl

    - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      run : |
        rm *.tmp
        ls
    
    - name: åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
      id: status
      run: |
        STR1="nothing to commit, working tree clean"
        STR2="Changes not staged for commit"
        out=$(git status)
        if [[ "$(echo $out | grep "$STR1")" != "" ]]
        then
          echo "::set-output name=status::"nochange""
        fi
        if [[ "$(echo $out | grep "$STR2")" != "" ]]
        then
          echo "::set-output name=status::"change""
        fi
    
    - name: åˆå¹¶åˆ°ä»“åº“
      run : |
        if [[ "${{steps.status.outputs.status}}" == "change" ]]
        then
          git add .
          git commit -m  "Update:${{steps.date.outputs.DATE}}"
          git push origin main
        fi

    - name: ç§»é™¤workflowè¿è¡Œ
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Telegramæ¨é€
      if: env.TELEGRAM_NOTIFICATION == 'true' && !cancelled()  
      run: |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=${{ env.TELEGRAM_NOTIFICATION_CONTENT }}&parse_mode=HTML"
        fi
        
