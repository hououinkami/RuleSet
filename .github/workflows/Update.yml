name: æ›´æ–°è§„åˆ™

on:
  push:
    branches:
      - master
    path:
      - .*
  release:
    types: [published]
  schedule:
    - cron: 0 1 * * *
  watch:
    types: [started]

env:
  TZ: Asia/Shanghai
  TELEGRAM_NOTIFICATION: false
  TELEGRAM_NOTIFICATION_CONTENT: <b>ğŸš« anti-ADãƒ«ãƒ¼ãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼</b>
  SOURCE_limbo: https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/Adblock4limbo.list
  SOURCE_limbo_NAME: limbo.tmp
  SOURCE_Geo: https://raw.githubusercontent.com/VirgilClyne/iRingo/main/sgmodule/Geo_Services.sgmodule
  SOURCE_Geo_NAME: Geo.tmp


jobs:
  UpdateRule:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        ref: master
        fetch-depth: 0
        lfs: true
    
    - name: Set git identity
      run : |
        git config --global user.email "hououinkami@gmail.com"
        git config --global user.name "hououinkami"
    
    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "::set-output name=DATE::$(date +'%Y-%m-%d')"
    
    - name: è·å–æœ€æ–°æº
      run : |
        wget $SOURCE_limbo -O $SOURCE_limbo_NAME
        wget $SOURCE_Geo -O $SOURCE_Geo_NAME
    
    - name: ç”Ÿæˆæ—¥æœ¬åŒºåŸŸå®šä½ä¿®æ”¹
      run : |
        awk '
        {
          gsub("HK","JP");
          print $0;
        }
        ' $SOURCE_Geo_NAME>Geo_Services.sgmodule

    - name: ç”ŸæˆRuleSet_for_Surgio_Adblock4limbo
      run : |
        awk '
        {
          if($0~/, reject/) {
            gsub(", reject","");
            print $0;
          };
        }
        ' $SOURCE_limbo_NAME>Adblock4limbo.list

    - name: ç”ŸæˆRuleSet_for_Clash_Adblock4limbo
      run : |
        cp Adblock4limbo.list Adblock4limbo1.tmp
        sed "1 i\   
        payload:
        " Adblock4limbo1.tmp > Adblock4limbo2.tmp
        awk '
        {
          if ($0~/payload/) {print $0};
          if ($0~/\#/) {
            gsub(/\#/, "\#  - ");
            print $0;
          };
          if ($0!~/payload|\#/) {print "  - " $0};
        }
        ' Adblock4limbo2.tmp>Clash/Adblock4limbo.yaml
    
    - name: ç”ŸæˆRuleSet_for_Clash
      run : |
        FILES=*.list
        for f in $FILES
        do
          sed "1 i\   
          payload:
          " $f > ${f%%.*}.tmp
          awk '
          {
            if ($0~/payload/) {print $0};
            if ($0~/\#/) {print $0};
            if ($0!~/payload|\#/ && $0!="") {print "  - " $0};
          }
          ' ${f%%.*}.tmp>Clash/${f%%.*}.yaml
        done    
    
    - name: ç”ŸæˆSpecial
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Special.list -O Special.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve","");
            print $0",ğŸŒ ç›´è¿"
          }
        }
        ' Special.tmp>Surge2QuanX/Special.list

    - name: ç”ŸæˆReject
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Reject.list -O Reject.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",ğŸš« å±è”½"
          }
        }
        ' Reject.tmp>Surge2QuanX/Reject.list

    - name: ç”ŸæˆYouTube
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Media/YouTube.list -O YouTube.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",ğŸ¬ YouTube"
          }
        }
        ' YouTube.tmp>Surge2QuanX/YouTube.list

    - name: ç”ŸæˆSpeedtest
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Speedtest.list -O Speedtest.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",â² Speedtest"
          }
        }
        ' Speedtest.tmp>Surge2QuanX/Speedtest.list

    - name: ç”ŸæˆGlobal
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Proxy.list -O Global.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",ğŸŒ ä»£ç†"
          }
        }
        ' Global.tmp>Surge2QuanX/Global.list

    - name: ç”ŸæˆApple
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Apple.list -O Apple.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",ğŸ Apple"
          }
        }
        ' Apple.tmp>Surge2QuanX/Apple.list

    - name: ç”ŸæˆChina
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Domestic.list -O China.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            gsub("IP-CIDR6","ip6-cidr");
            print $0",ğŸŒ ç›´è¿"
          }
        }
        ' China.tmp>Surge2QuanX/China.list

    - name: ç”ŸæˆChinaIP
      run : |
        wget https://raw.githubusercontent.com/lhie1/Rules/master/Surge/Surge%203/Provider/Domestic%20IPs.list -O ChinaIP.tmp
        awk '
        {
          if($0~/,/ && $0!~/PROCESS-NAME|URL-REGEX/) {
            gsub(",no-resolve",""); 
            print $0",ğŸŒ ç›´è¿"
          }
        }
        ' ChinaIP.tmp>Surge2QuanX/ChinaIP.list

    - name: ç”ŸæˆRewrite
      run : |
        wget https://raw.githubusercontent.com/Orz-3/QuantumultX/master/YouTube.conf -O Rewrite/YouTubeAD.conf
        wget https://raw.githubusercontent.com/qiangxinglin/Emby/main/QuantumultX/emby.conf -O Rewrite/EMBY.conf
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Quantumult/Rewrite/General.conf -O Rewrite/General.conf
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Quantumult/Rewrite/Block/Advertising.conf -O Rewrite/Advertising.conf
        wget https://raw.githubusercontent.com/DivineEngine/Profiles/master/Quantumult/Rewrite/Block/AdvertisingPlus.conf -O Rewrite/AdvertisingPlus.conf

    - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      run : |
        rm *.tmp
        ls
    
    - name: åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
      id: status
      run: |
        STR1="nothing to commit, working tree clean"
        STR2="Changes not staged for commit"
        out=$(git status)
        if [[ "$(echo $out | grep "$STR1")" != "" ]]
        then
          echo "::set-output name=status::"nochange""
        fi
        if [[ "$(echo $out | grep "$STR2")" != "" ]]
        then
          echo "::set-output name=status::"change""
        fi
    
    - name: åˆå¹¶åˆ°ä»“åº“
      run : |
        if [[ "${{steps.status.outputs.status}}" == "change" ]]
        then
          git add .
          git commit -m  "Update:${{steps.date.outputs.DATE}}"
          git push origin master
        fi

    - name: ç§»é™¤workflowè¿è¡Œ
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Telegramæ¨é€
      if: env.TELEGRAM_NOTIFICATION == 'true' && !cancelled()  
      run: |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=${{ env.TELEGRAM_NOTIFICATION_CONTENT }}&parse_mode=HTML"
        fi
        
